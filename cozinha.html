<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel de Cozinha - Ribbs Zn</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Estilos adicionais para o painel de cozinha */
      body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
      }
      header {
        background: #000;
        padding: 20px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
      }
      section {
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      .pedidos-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .card-pedido {
        background: #222;
        border-radius: 12px;
        padding: 16px;
        width: 300px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      }
      .card-pedido.novo {
        border: 2px solid var(--amarelo);
      }
      .card-pedido.em-preparo {
        border: 2px solid var(--vermelho);
      }
      .card-pedido.pronto {
        border: 2px solid green;
      }
      .itens-lista {
        list-style: none;
        padding: 0;
      }
      .itens-lista li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .btn-remove {
        background: red;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
      }
      .btn-aceitar,
      .btn-recusar,
      .btn-imprimir,
      .btn-add,
      .btn-pronto {
        padding: 10px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-aceitar {
        background: green;
        color: white;
      }
      .btn-recusar {
        background: red;
        color: white;
      }
      .btn-imprimir {
        background: blue;
        color: white;
      }
      .btn-add {
        background: var(--amarelo);
        color: black;
      }
      .btn-pronto {
        background: #28a745;
        color: white;
      }
      .btn-novo-pedido {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--amarelo);
        color: black;
        padding: 15px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
      }
      @media print {
        body * {
          visibility: hidden;
        }
        .print-content,
        .print-content * {
          visibility: visible;
        }
        .print-content {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          font-size: 12pt;
          font-family: monospace;
        }
      }
      .sessao-topo {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 20px;
        margin: 16px 0;
        padding: 0 12px;
        overflow-x: auto;
      }
      .sessao-topo button {
        background: #fff;
        color: #000;
        border-radius: 12px;
        border: none;
        padding: 16px 24px;
        font-weight: bold;
        cursor: pointer;
        font-size: 20px;
        min-width: 160px;
        min-height: 48px;
      }
      .sessao-topo button.active {
        background-color: var(--vermelho);
        color: white;
      }
      .cardapio {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        padding: 20px;
        overflow-x: auto;
      }
      .card {
        background: #fff;
        color: #000;
        width: 130px;
        border-radius: 15px;
        padding: 10px;
        text-align: center;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.18);
        flex: 0 0 auto;
      }
      .card img {
        width: 100px;
        height: 50px;
        margin-bottom: 10px;
        border-radius: 8px;
        object-fit: cover;
      }
      .options-row {
        display: flex;
        justify-content: space-around;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: nowrap;
      }
      .small-option {
        flex: 1;
        text-align: center;
        margin: 6px 0;
        min-height: 48px;
      }
      .small-option p:first-child {
        font-weight: bold;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <header>Painel de Cozinha - Ribbs Zn</header>
    <section id="novos-pedidos">
      <h2>Novos Pedidos</h2>
      <div class="pedidos-container"></div>
    </section>
    <section id="pedidos-em-preparo">
      <h2>Pedidos em Preparo</h2>
      <div class="pedidos-container"></div>
    </section>
    <section id="pedidos-prontos">
      <h2>Pedidos Prontos</h2>
      <div class="pedidos-container"></div>
    </section>
    <audio id="soundPedido" src="pedido.mp3" preload="auto"></audio>

    <!-- Modal de Personalização (reutilizado do index.html) -->
    <div id="popupCustom" class="popup" aria-hidden="true">
      <button
        class="closePopup"
        onclick="closePopupCustom()"
        role="button"
        aria-label="Fechar"
      >
        X
      </button>
      <h3 id="popupCustomTitle">Personalize seu item</h3>
      <div id="popupQuestion"></div>
      <div id="popupResumo"></div>
      <div style="text-align: center; margin-top: 10px">
        <button
          class="btn"
          id="confirmCustomBtn"
          onclick="confirmPopupCustom()"
          role="button"
          aria-label="Adicionar ao carrinho"
        >
          Adicionar ao carrinho
        </button>
      </div>
    </div>

    <!-- Modal para Novo Pedido (Nome do Cliente) -->
    <div id="popupNovoPedido" class="popup" aria-hidden="true">
      <button
        class="closePopup"
        onclick="closeNovoPedidoPopup()"
        role="button"
        aria-label="Fechar"
      >
        X
      </button>
      <h3>Digite o nome do cliente</h3>
      <input type="text" id="inputNomeNovo" readonly />
      <div id="keyboardNovo"></div>
      <div style="text-align: center; margin-top: 12px">
        <button
          class="btn"
          onclick="confirmNovoPedido()"
          style="background: var(--vermelho); color: #fff"
          role="button"
          aria-label="Confirmar"
        >
          Confirmar
        </button>
      </div>
    </div>

    <!-- Modal para Seleção de Categoria -->
    <div id="popupCategoria" class="popup" aria-hidden="true">
      <button
        class="closePopup"
        onclick="closeCategoriaPopup()"
        role="button"
        aria-label="Fechar"
      >
        X
      </button>
      <h3>Selecione a Categoria</h3>
      <div class="sessao-topo" id="sessao-topo-categoria"></div>
      <div class="cardapio" id="cardapio-categoria"></div>
    </div>

    <div id="backdrop" class="backdrop"></div>

    <button class="btn-novo-pedido" onclick="openNovoPedidoPopup()">+</button>

    <script>
      let cardapioData = {};
      let pedidosPendentes =
        JSON.parse(localStorage.getItem("pedidos_pendentes")) || [];
      let pedidosEmPreparo = [];
      let pedidosProntos = [];
      let logRecusados =
        JSON.parse(localStorage.getItem("log_pedidos_recusados")) || [];
      let currentPedidoId = null; // Para adicionar item a pedido específico
      const soundPedido = document.getElementById("soundPedido");
      let currentItem = null;
      let currentCat = null;

      // Funções utilitárias do script.js
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function getIngredientesParaOpcao(item, opcao) {
        return (
          item.ingredientesPorOpcao?.[opcao] ||
          item.ingredientesPadrao ||
          item.ingredientes ||
          []
        );
      }

      function getIngredsForComboCompat(item, burgerName) {
        if (
          item.simplesIngredients &&
          burgerName.toLowerCase().includes("simples")
        ) {
          return {
            ingredients: item.simplesIngredients,
            vegetables: item.simplesVegetables,
          };
        }
        if (
          item.duploIngredients &&
          burgerName.toLowerCase().includes("duplo")
        ) {
          return {
            ingredients: item.duploIngredients,
            vegetables: item.duploVegetables,
          };
        }
        return {
          ingredients: item.ingredients || [],
          vegetables: item.vegetables || [],
        };
      }

      function hasCustomization(item) {
        return !!(
          item.combo ||
          item.adicionais?.length > 0 ||
          item.ingredientesPorOpcao ||
          item.ingredientesPadrao?.length ||
          item.ingredients?.length ||
          item.simplesIngredients ||
          item.duploIngredients
        );
      }

      // Carregar cardapio.json
      async function loadCardapio() {
        try {
          const response = await fetch("cardapio.json");
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          cardapioData = await response.json();
        } catch (e) {
          console.error("Erro ao carregar cardapio.json:", e);
        }
      }

      loadCardapio();

      // Polling para novos pedidos
      setInterval(checkNovosPedidos, 5000);

      function checkNovosPedidos() {
        const newPedidos =
          JSON.parse(localStorage.getItem("pedidos_pendentes")) || [];
        if (newPedidos.length > pedidosPendentes.length) {
          soundPedido.play().catch(() => {});
        }
        pedidosPendentes = newPedidos;
        renderNovosPedidos();
      }

      // Renderizar novos pedidos
      function renderNovosPedidos() {
        const container = document.querySelector(
          "#novos-pedidos .pedidos-container"
        );
        container.innerHTML = "";
        pedidosPendentes.forEach((pedido, index) => {
          if (!pedido.code) pedido.code = generateCode();
          const card = createPedidoCard(pedido, index, "novo");
          container.appendChild(card);
        });
        updateLocalStorage();
      }

      // Renderizar pedidos em preparo
      function renderEmPreparo() {
        const container = document.querySelector(
          "#pedidos-em-preparo .pedidos-container"
        );
        container.innerHTML = "";
        pedidosEmPreparo.forEach((pedido, index) => {
          const card = createPedidoCard(pedido, index, "em-preparo");
          container.appendChild(card);
        });
      }

      // Renderizar pedidos prontos
      function renderProntos() {
        const container = document.querySelector(
          "#pedidos-prontos .pedidos-container"
        );
        container.innerHTML = "";
        pedidosProntos.forEach((pedido, index) => {
          const card = createPedidoCard(pedido, index, "pronto");
          container.appendChild(card);
        });
      }

      // Criar card de pedido
      function createPedidoCard(pedido, index, status) {
        const card = document.createElement("div");
        card.className = `card-pedido ${status}`;
        card.innerHTML = `
                <h3>Pedido #${pedido.code} - ${escapeHtml(
          pedido.nomeCliente
        )}</h3>
                <p>Total: R$ ${pedido.total.toFixed(2)}</p>
                <p>Tempo: ${calculateTempo(pedido.dataHora)}</p>
                <ul class="itens-lista"></ul>
                <button class="btn-add" onclick="openCategoriaPopup(${index}, '${status}')">Adicionar Item</button>
                ${
                  status === "novo"
                    ? '<button class="btn-aceitar" onclick="aceitarPedido(' +
                      index +
                      ')">Aceitar</button>'
                    : ""
                }
                ${
                  status === "em-preparo"
                    ? '<button class="btn-pronto" onclick="prontoPedido(' +
                      index +
                      ')">Pronto</button>'
                    : ""
                }
                <button class="btn-recusar" onclick="recusarPedido(${index}, '${status}')">Recusar</button>
                <button class="btn-imprimir" onclick="imprimirPedido(${index}, '${status}')">Imprimir</button>
            `;

        const lista = card.querySelector(".itens-lista");
        pedido.itens.forEach((item, i) => {
          const li = document.createElement("li");
          li.innerHTML = `${escapeHtml(item.item)} x ${item.quantity} - R$ ${(
            item.price * item.quantity
          ).toFixed(2)}
                    <button class="btn-remove" onclick="removeItem(${index}, ${i}, '${status}')">X</button>`;
          lista.appendChild(li);
        });

        return card;
      }

      // Gerar código de 4 dígitos
      function generateCode() {
        return Math.floor(1000 + Math.random() * 9000).toString();
      }

      // Calcular tempo desde dataHora
      function calculateTempo(dataHora) {
        const now = new Date();
        const pedidoTime = new Date(dataHora);
        const diff = Math.floor((now - pedidoTime) / 60000); // minutos
        return `${diff} min`;
      }

      // Aceitar pedido
      function aceitarPedido(index) {
        const pedido = pedidosPendentes.splice(index, 1)[0];
        pedidosEmPreparo.push(pedido);
        renderNovosPedidos();
        renderEmPreparo();
      }

      // Marcar como pronto
      function prontoPedido(index) {
        const pedido = pedidosEmPreparo.splice(index, 1)[0];
        pedidosProntos.push(pedido);
        renderEmPreparo();
        renderProntos();
      }

      // Recusar pedido
      function recusarPedido(index, status) {
        let pedido;
        if (status === "novo") {
          pedido = pedidosPendentes.splice(index, 1)[0];
        } else if (status === "em-preparo") {
          pedido = pedidosEmPreparo.splice(index, 1)[0];
        } else if (status === "pronto") {
          pedido = pedidosProntos.splice(index, 1)[0];
        }
        logRecusados.push(pedido);
        localStorage.setItem(
          "log_pedidos_recusados",
          JSON.stringify(logRecusados)
        );
        renderNovosPedidos();
        renderEmPreparo();
        renderProntos();
      }

      // Remover item
      function removeItem(pedidoIndex, itemIndex, status) {
        let pedidos;
        if (status === "novo") pedidos = pedidosPendentes;
        else if (status === "em-preparo") pedidos = pedidosEmPreparo;
        else if (status === "pronto") pedidos = pedidosProntos;
        pedidos[pedidoIndex].itens.splice(itemIndex, 1);
        recalculateTotal(pedidos[pedidoIndex]);
        updateLocalStorage();
        if (status === "novo") renderNovosPedidos();
        else if (status === "em-preparo") renderEmPreparo();
        else if (status === "pronto") renderProntos();
        showFeedback("Item removido");
      }

      // Recalcular total
      function recalculateTotal(pedido) {
        pedido.total = pedido.itens.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
      }

      // Abrir popup de categorias para adicionar item
      function openCategoriaPopup(pedidoIndex, status) {
        currentPedidoId = { index: pedidoIndex, status };
        populateCategorias();
        openPopup("popupCategoria");
      }

      function closeCategoriaPopup() {
        closePopup("popupCategoria", () => closeBackdrop());
      }

      function populateCategorias() {
        const topo = document.getElementById("sessao-topo-categoria");
        topo.innerHTML = "";
        const cats = Object.keys(cardapioData);
        cats.forEach((cat) => {
          const btn = document.createElement("button");
          btn.textContent = cat;
          btn.onclick = () => {
            document
              .querySelectorAll("#sessao-topo-categoria button")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            showItemsInCategory(cat);
          };
          topo.appendChild(btn);
        });
        if (cats.length > 0) {
          topo.children[0].click();
        }
      }

      function showItemsInCategory(cat) {
        currentCat = cat;
        const container = document.getElementById("cardapio-categoria");
        container.innerHTML = "";
        (cardapioData[cat] || []).forEach((item, i) => {
          const card = document.createElement("div");
          card.className = "card";

          if (item.img) {
            const img = document.createElement("img");
            img.src = item.img;
            img.alt = item.nome;
            card.appendChild(img);
          }

          const title = document.createElement("h3");
          title.textContent = item.nome;
          card.appendChild(title);

          if (item.descricao) {
            const desc = document.createElement("p");
            desc.className = "descricao";
            desc.textContent = item.descricao;
            card.appendChild(desc);
          }

          const optionsRow = document.createElement("div");
          optionsRow.className = "options-row";

          const opcoes = item.opcoes || [""];
          opcoes.forEach((op, j) => {
            const price = item.precoBase[j] ?? item.precoBase[0] ?? 0;
            const optionDiv = document.createElement("div");
            optionDiv.className = "small-option";
            optionDiv.innerHTML = `<p>${op || item.nome}</p><p>R$ ${Number(
              price
            ).toFixed(2)}</p>`;

            const addBtn = document.createElement("button");
            addBtn.className = "btn";
            addBtn.textContent = hasCustomization(item)
              ? "Personalizar"
              : "Adicionar";
            addBtn.onclick = () => {
              if (hasCustomization(item)) {
                closeCategoriaPopup();
                openPopupCustom(currentCat, i, j);
              } else {
                adicionarDiretoToPedido(
                  item.nome + (op ? " " + op : ""),
                  price
                );
                closeCategoriaPopup();
              }
            };
            optionDiv.appendChild(addBtn);

            optionsRow.appendChild(optionDiv);
          });

          card.appendChild(optionsRow);
          container.appendChild(card);
        });
      }

      function adicionarDiretoToPedido(nome, preco) {
        let pedidos;
        if (currentPedidoId.status === "novo") pedidos = pedidosPendentes;
        else if (currentPedidoId.status === "em-preparo")
          pedidos = pedidosEmPreparo;
        else if (currentPedidoId.status === "pronto") pedidos = pedidosProntos;
        const existing = pedidos[currentPedidoId.index].itens.find(
          (i) => i.item === nome.trim()
        );
        if (existing) {
          existing.quantity++;
        } else {
          pedidos[currentPedidoId.index].itens.push({
            item: nome.trim(),
            price: Number(preco),
            quantity: 1,
          });
        }
        recalculateTotal(pedidos[currentPedidoId.index]);
        updateLocalStorage();
        if (currentPedidoId.status === "novo") renderNovosPedidos();
        else if (currentPedidoId.status === "em-preparo") renderEmPreparo();
        else if (currentPedidoId.status === "pronto") renderProntos();
      }

      // Imprimir pedido
      function imprimirPedido(index, status) {
        let pedido;
        if (status === "novo") pedido = pedidosPendentes[index];
        else if (status === "em-preparo") pedido = pedidosEmPreparo[index];
        else if (status === "pronto") pedido = pedidosProntos[index];
        let printWindow = window.open("", "", "height=500,width=800");
        printWindow.document.write("<html><head><title>Cupom</title>");
        printWindow.document.write(
          "<style>@media print { body { font-family: monospace; font-size: 12pt; } }</style>"
        );
        printWindow.document.write('</head><body class="print-content">');
        printWindow.document.write("<h2>Ribbs Zn</h2>");
        printWindow.document.write(
          "<p>Rua Lauro de Souza, 465 - Campo Grande</p>"
        );
        printWindow.document.write(
          `<p>Cliente: ${escapeHtml(pedido.nomeCliente)}</p>`
        );
        printWindow.document.write(`<p>Código: ${pedido.code}</p>`);
        printWindow.document.write("<p>Forma de Pagamento:</p>");
        pedido.pagamentos.forEach((p) => {
          printWindow.document.write(
            `<p>- ${p.method} R$ ${p.value.toFixed(2)} ${
              p.troco > 0 ? "(Troco: R$ " + p.troco.toFixed(2) + ")" : ""
            }</p>`
          );
        });
        printWindow.document.write("<p>Itens:</p>");
        pedido.itens.forEach((item) => {
          printWindow.document.write(
            `<p>${escapeHtml(item.item)} x ${item.quantity} - R$ ${(
              item.price * item.quantity
            ).toFixed(2)}</p>`
          );
        });
        printWindow.document.write(
          "<p>Subtotal: R$ " + pedido.total.toFixed(2) + "</p>"
        );
        printWindow.document.write("<p>Taxa de Entrega: R$ 0.00</p>");
        printWindow.document.write(
          "<p>Total Geral: R$ " + pedido.total.toFixed(2) + "</p>"
        );
        printWindow.document.write("</body></html>");
        printWindow.document.close();
        printWindow.print();
      }

      // Atualizar Local Storage
      function updateLocalStorage() {
        localStorage.setItem(
          "pedidos_pendentes",
          JSON.stringify(pedidosPendentes)
        );
      }

      // Mostrar feedback temporário
      function showFeedback(message) {
        const feedback = document.createElement("div");
        feedback.textContent = message;
        feedback.style.position = "fixed";
        feedback.style.bottom = "20px";
        feedback.style.left = "50%";
        feedback.style.transform = "translateX(-50%)";
        feedback.style.background = "green";
        feedback.style.color = "white";
        feedback.style.padding = "10px";
        feedback.style.borderRadius = "8px";
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 3000);
      }

      // Funções para modal (adaptadas de script.js)
      function openPopup(id) {
        const popup = document.getElementById(id);
        const backdrop = document.getElementById("backdrop");
        popup.style.display = "block";
        backdrop.style.display = "block";
        requestAnimationFrame(() => {
          popup.classList.add("show");
          backdrop.classList.add("show");
        });
      }

      function closePopup(id, callback) {
        const popup = document.getElementById(id);
        popup.classList.add("hiding");
        popup.addEventListener(
          "transitionend",
          () => {
            popup.style.display = "none";
            popup.classList.remove("hiding", "show");
            callback?.();
          },
          { once: true }
        );
      }

      function closeBackdrop(callback) {
        const backdrop = document.getElementById("backdrop");
        backdrop.classList.add("hiding");
        backdrop.addEventListener(
          "transitionend",
          () => {
            backdrop.style.display = "none";
            backdrop.classList.remove("hiding", "show");
            callback?.();
          },
          { once: true }
        );
      }

      function closePopupCustom() {
        closePopup("popupCustom", () => closeBackdrop());
      }

      function openPopupCustom(cat, itemIndex, optionIndex) {
        currentItem = { cat, itemIndex, optionIndex };
        const item = cardapioData[cat][itemIndex];
        const opcao = item.opcoes ? item.opcoes[optionIndex] : "";
        const basePrice = item.precoBase[optionIndex] ?? item.precoBase[0] ?? 0;
        document.getElementById(
          "popupCustomTitle"
        ).textContent = `Personalize: ${item.nome} ${opcao}`;

        const questionDiv = document.getElementById("popupQuestion");
        const resumoDiv = document.getElementById("popupResumo");
        questionDiv.innerHTML = "";
        resumoDiv.innerHTML = "";

        function updateResumo() {
          let total = basePrice;
          let summary = "";

          if (item.combo) {
            const burgers = item.burgers || [];
            burgers.forEach((burgerName, bIndex) => {
              summary += `<h4>${burgerName}</h4>`;
              const ingreds = getIngredsForComboCompat(item, burgerName);
              let rem = [];
              (ingreds.vegetables || []).forEach((veg) => {
                const chk = document.getElementById(`veg_${bIndex}_${veg}`);
                if (chk && !chk.checked) rem.push(veg);
              });
              summary += `<p>Removidos: ${rem.join(", ") || "Nenhum"}</p>`;

              let adds = [];
              const extras = item.paidExtras || item.adicionais || [];
              extras.forEach((extra) => {
                const chk = document.getElementById(
                  `extra_${bIndex}_${extra.nome}`
                );
                if (chk && chk.checked) {
                  adds.push(`${extra.nome} (+R$ ${extra.preco.toFixed(2)})`);
                  total += extra.preco;
                }
              });
              summary += `<p>Adicionados: ${adds.join(", ") || "Nenhum"}</p>`;
            });
          } else {
            let rem = [];
            const removable = getIngredientesParaOpcao(item, opcao);
            removable.forEach((ing) => {
              const chk = document.getElementById(`ing_0_${ing}`);
              if (chk && !chk.checked) rem.push(ing);
            });
            summary += `<p>Removidos: ${rem.join(", ") || "Nenhum"}</p>`;

            let adds = [];
            const extras = item.adicionais || item.paidExtras || [];
            extras.forEach((extra) => {
              const chk = document.getElementById(`extra_0_${extra.nome}`);
              if (chk && chk.checked) {
                adds.push(`${extra.nome} (+R$ ${extra.preco.toFixed(2)})`);
                total += extra.preco;
              }
            });
            summary += `<p>Adicionados: ${adds.join(", ") || "Nenhum"}</p>`;
          }

          // Adicionais gerais
          let genAdds = [];
          (item.adicionais || []).forEach((add) => {
            const chk = document.getElementById(`add_0_${add.nome}`);
            if (chk && chk.checked) {
              genAdds.push(`${add.nome} (+R$ ${add.preco.toFixed(2)})`);
              total += add.preco;
            }
          });
          if (genAdds.length) {
            summary += `<h4>Opções Adicionais</h4><p>${genAdds.join(", ")}</p>`;
          }

          resumoDiv.innerHTML =
            summary + `<p><strong>Total: R$ ${total.toFixed(2)}</strong></p>`;
        }

        if (item.combo) {
          const burgers = item.burgers || [];
          burgers.forEach((burgerName, bIndex) => {
            const section = document.createElement("div");
            section.innerHTML = `<h4>${burgerName}</h4>`;

            const ingreds = getIngredsForComboCompat(item, burgerName);
            if (ingreds.vegetables && ingreds.vegetables.length) {
              const vegDiv = document.createElement("div");
              vegDiv.innerHTML = "<p>Vegetais (desmarque para remover):</p>";
              ingreds.vegetables.forEach((veg) => {
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.checked = true;
                chk.id = `veg_${bIndex}_${veg}`;
                chk.addEventListener("change", updateResumo);
                const label = document.createElement("label");
                label.htmlFor = chk.id;
                label.textContent = veg;
                vegDiv.appendChild(chk);
                vegDiv.appendChild(label);
                vegDiv.appendChild(document.createElement("br"));
              });
              section.appendChild(vegDiv);
            }

            const extras = item.paidExtras || item.adicionais || [];
            if (extras.length) {
              const extraDiv = document.createElement("div");
              extraDiv.innerHTML = "<p>Adicionais pagos:</p>";
              extras.forEach((extra) => {
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.id = `extra_${bIndex}_${extra.nome}`;
                chk.dataset.price = extra.preco;
                chk.addEventListener("change", updateResumo);
                const label = document.createElement("label");
                label.htmlFor = chk.id;
                label.textContent = `${extra.nome} +R$ ${extra.preco.toFixed(
                  2
                )}`;
                extraDiv.appendChild(chk);
                extraDiv.appendChild(label);
                extraDiv.appendChild(document.createElement("br"));
              });
              section.appendChild(extraDiv);
            }

            questionDiv.appendChild(section);
          });
        } else {
          const removable = getIngredientesParaOpcao(item, opcao);
          if (removable.length) {
            const vegDiv = document.createElement("div");
            vegDiv.innerHTML = "<p>Ingredientes (desmarque para remover):</p>";
            removable.forEach((ing) => {
              const chk = document.createElement("input");
              chk.type = "checkbox";
              chk.checked = true;
              chk.id = `ing_0_${ing}`;
              chk.addEventListener("change", updateResumo);
              const label = document.createElement("label");
              label.htmlFor = chk.id;
              label.textContent = ing;
              vegDiv.appendChild(chk);
              vegDiv.appendChild(label);
              vegDiv.appendChild(document.createElement("br"));
            });
            questionDiv.appendChild(vegDiv);
          }

          const extras = item.adicionais || item.paidExtras || [];
          if (extras.length) {
            const extraDiv = document.createElement("div");
            extraDiv.innerHTML = "<p>Adicionais:</p>";
            extras.forEach((extra) => {
              const chk = document.createElement("input");
              chk.type = "checkbox";
              chk.id = `extra_0_${extra.nome}`;
              chk.dataset.price = extra.preco;
              chk.addEventListener("change", updateResumo);
              const label = document.createElement("label");
              label.htmlFor = chk.id;
              label.textContent = `${extra.nome}${
                extra.preco > 0 ? " +R$ " + extra.preco.toFixed(2) : ""
              }`;
              extraDiv.appendChild(chk);
              extraDiv.appendChild(label);
              extraDiv.appendChild(document.createElement("br"));
            });
            questionDiv.appendChild(extraDiv);
          }
        }

        // Adicionais gerais (ex: para batata em combo)
        if (item.adicionais && item.combo) {
          const addDiv = document.createElement("div");
          addDiv.innerHTML = "<h4>Opções Adicionais</h4><p>Selecione:</p>";
          item.adicionais.forEach((add) => {
            const chk = document.createElement("input");
            chk.type = "checkbox";
            chk.id = `add_0_${add.nome}`;
            chk.dataset.price = add.preco;
            chk.addEventListener("change", updateResumo);
            const label = document.createElement("label");
            label.htmlFor = chk.id;
            label.textContent = `${add.nome}${
              add.preco > 0 ? " +R$ " + add.preco.toFixed(2) : ""
            }`;
            addDiv.appendChild(chk);
            addDiv.appendChild(label);
            addDiv.appendChild(document.createElement("br"));
          });
          questionDiv.appendChild(addDiv);
        }

        updateResumo();
        openPopup("popupCustom");
      }

      // Funções para modal de novo pedido
      function openNovoPedidoPopup() {
        document.getElementById("inputNomeNovo").value = "";
        populateKeyboardNovo();
        openPopup("popupNovoPedido");
      }

      function closeNovoPedidoPopup() {
        closePopup("popupNovoPedido", () => closeBackdrop());
      }

      function confirmNovoPedido() {
        const nomeCliente = document
          .getElementById("inputNomeNovo")
          .value.trim();
        if (nomeCliente === "")
          return showFeedback("Nome do cliente obrigatório");
        const newPedido = {
          nomeCliente,
          dataHora: new Date().toISOString(),
          itens: [],
          total: 0,
          pagamentos: [{ method: "Dinheiro", value: 0, troco: 0 }],
          local: "Aqui", // Default, pode ajustar
        };
        pedidosPendentes.push(newPedido);
        renderNovosPedidos();
        closeNovoPedidoPopup();
        // Abrir popup de categorias para adicionar itens ao novo pedido
        openCategoriaPopup(pedidosPendentes.length - 1, "novo");
      }

      function populateKeyboardNovo() {
        const keyboard = document.getElementById("keyboardNovo");
        if (keyboard.children.length > 0) return;

        const keys = [
          "Q",
          "W",
          "E",
          "R",
          "T",
          "Y",
          "U",
          "I",
          "O",
          "P",
          "A",
          "S",
          "D",
          "F",
          "G",
          "H",
          "J",
          "K",
          "L",
          "Z",
          "X",
          "C",
          "V",
          "B",
          "N",
          "M",
        ];

        keys.forEach((key) => {
          const btn = document.createElement("button");
          btn.textContent = key;
          btn.dataset.key = key;
          keyboard.appendChild(btn);
        });

        const spaceBtn = document.createElement("button");
        spaceBtn.classList.add("space");
        spaceBtn.textContent = "Space";
        spaceBtn.dataset.key = " ";
        keyboard.appendChild(spaceBtn);

        const backBtn = document.createElement("button");
        backBtn.classList.add("backspace");
        backBtn.textContent = "⌫";
        backBtn.dataset.key = "⌫";
        keyboard.appendChild(backBtn);

        keyboard.addEventListener("click", (e) => {
          if (e.target.tagName !== "BUTTON") return;
          const key = e.target.dataset.key;
          const input = document.getElementById("inputNomeNovo");
          if (key === "⌫") {
            input.value = input.value.slice(0, -1);
          } else {
            input.value += key;
          }
        });
      }

      // Inicial render
      renderNovosPedidos();
      renderEmPreparo();
      renderProntos();
    </script>
  </body>
</html>
